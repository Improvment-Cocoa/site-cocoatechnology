<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3185/3185082.png" type="image/x-icon">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/dashboard-especifica.css">
    <title>Dashboard - Cocoa</title>
</head>
<!-- onload="obterDadosGrafico() -->

<body>
    <div id="dashboard-container">
        <nav class="select-disable" id="nav">
            <img src="../assets/img/logotipo/branco.png" alt="Logo Cocoa Technology">
            <div class="texto-user">
                <span>Bem-vindo</span>
                <span id="b_usuario"></span>
            </div>
            <ul class="nav-list">
                <li><a href="./dashboard-geral.html"><img class="icon-nav" src="../assets/img/icones/global.png"
                            alt="Geral"><span>Geral</span></a></li>
                <li><a href="./dashboard-umid.html"><img class="icon-nav" src="../assets/img/icones/moisture-white.png"
                            alt="Umidade">
                        <span>Umidade</span></a>
                </li>
                <li class="pag-atual"><a href="#"><img class="icon-nav" src="../assets/img/icones/thermometer-white.png"
                            alt="Temperatura"><span>Temperatura</span></a>
                </li>
                <li><a href="./cadastrar-usuario.html">
                        <img class="icon-nav" src="../assets/img/icones/user.png" alt="Temperatura">
                        <span>Cadastrar Usuário</span>
                    </a>
                </li>
                <li>
                    <a href="./cadastro-plantacao.html">
                        <img class="icon-nav" src="../assets/img/icones/folha.png" alt="Temperatura">
                        <span>Cadastrar Plantações</span>
                    </a>
                </li>
            </ul>
            <a href="../login.html"><button>SAIR</button></a>
        </nav>
        <div id="content">
            <div class="div-search"><input type="text" placeholder="Pesquisar"></div>
            <span id="plantacoes">
                <div class="slide-show select-disable">
                    <h2>Plantação - Rua Haddock Lobo</h2>
                    <ul class="slides-list">
                        <li class="slide">
                            <canvas id="myChart1"></canvas>
                        </li>
                        <li class="slide">
                            <div class="infos-graficos">
                                <h2>Status da plantação:</h2>
                                <span style="color: #74C365;" class="status">TRANQUILA</span>
                                <div>
                                    <div>
                                        <span>Temperatura atual:</span>
                                        <span style="color: #FF5555;">23°C</span>
                                    </div>
                                    <div>
                                        <span>Temperatura ideal:</span>
                                        <span>10°C a 23°C</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </span>
        </div>
    </div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    var plantacoes = [];
    var dataLeitura = [];
    var firstPlot = true;
    var temperaturaConstante = [];
    var cores = [];

    fetch(`/medidas/dados_temperatura/${sessionStorage.ID_USUARIO}`, {
        method: "GET"
    }).then(function (resposta) {
        if (resposta.ok) {
            resposta.json().then((jsonTemp) => {
                console.log(jsonTemp)
                jsonTemp.forEach(linha => {
                    plantacoes.innerHTML += `
                    <div class="slide-show select-disable">
                    <h2>Plantação - ${linha.nome}</h2>
                    <ul class="slides-list">
                        <li class="slide">
                            <canvas id="myChart${linha.idplantacao}"></canvas>
                        </li>
                        <li class="slide" id="info${linha.idplantacao}">
                            
                        </li>
                    </ul>
                </div>
                    `
                    plantacoes.push({ id: linha.idplantacao, nome: linha.nome, temp: linha.temperatura })
                    dataLeitura.push(linha.momento_grafico);
                });
            })
        }
    }).then(() => {
        for (i = 0; i < plantacoes.length; i++) {
            if (plantacoes[i].temp > 29 || plantacoes[i].temp < 17) {
                document.getElementById(`info${plantacoes[i].id}`).innerHTML = `
                    <div class="infos-graficos">
                                <h2>Status da plantação:</h2>
                                <span style="color: #FF5555;" class="status">PERIGO</span>
                                <div>
                                    <div>
                                        <span>Temperatura atual:</span>
                                        <span style="color: #FF5555;">${plantacoes[i].temp}°C</span>
                                    </div>
                                    <div>
                                        <span>Temperatura ideal:</span>
                                        <span>10°C a 23°C</span>
                                    </div>
                                </div>
                            </div>
                    `
            } else if ((plantacoes[i].temp >= 27 && plantacoes[i].temp <= 28) || (plantacoes[i].temp >= 17 && plantacoes[i].temp <= 19)) {
                document.getElementById(`info${plantacoes[i].id}`).innerHTML = `
                    <div class="infos-graficos">
                                <h2>Status da plantação:</h2>
                                <span style="color: #FF9900;" class="status">ATENÇÃO</span>
                                <div>
                                    <div>
                                        <span>Temperatura atual:</span>
                                        <span style="color: #FF9900;">${plantacoes[i].temp}°C</span>
                                    </div>
                                    <div>
                                        <span>Temperatura ideal:</span>
                                        <span>10°C a 23°C</span>
                                    </div>
                                </div>
                            </div>
                    `
            } else if (plantacoes[i].temp >= 25 && plantacoes[i].temp <= 26) {
                document.getElementById(`info${plantacoes[i].id}`).innerHTML = `
                    <div class="infos-graficos">
                                <h2>Status da plantação:</h2>
                                <span style="color: #FFCC00;" class="status">CUIDADO</span>
                                <div>
                                    <div>
                                        <span>Temperatura atual:</span>
                                        <span style="color: #FFCC00;">${plantacoes[i].temp}°C</span>
                                    </div>
                                    <div>
                                        <span>Temperatura ideal:</span>
                                        <span>10°C a 23°C</span>
                                    </div>
                                </div>
                            </div>
                    `
            } else {
                document.getElementById(`info${plantacoes[i].id}`).innerHTML = `
                    <div class="infos-graficos">
                                <h2>Status da plantação:</h2>
                                <span style="color: #74C365;" class="status">TRANQUILA</span>
                                <div>
                                    <div>
                                        <span>Temperatura atual:</span>
                                        <span style="color: #74C365;">${plantacoes[i].temp}°C</span>
                                    </div>
                                    <div>
                                        <span>Temperatura ideal:</span>
                                        <span>10°C a 23°C</span>
                                    </div>
                                </div>
                            </div>
                    `
            }
        }
    });

    function buscarLeitura() {
        fetch(`/medidas/dados_temperatura/${sessionStorage.ID_USUARIO}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then((resposta) => {
            if (resposta.ok) {
                resposta.json().then(json => {
                    if (temperaturaConstante.length < 6) {
                        temperaturaConstante.push(json[0].temperatura)
                        dataLeitura.push(json[0].momento_grafico)
                    } else {
                        temperaturaConstante.shift()
                        dataLeitura.shift()

                        temperaturaConstante.push(json[0].temperatura)
                        dataLeitura.push(json[0].momento_grafico)
                    }
                })
            }
        })
        setTimeout(() => {
            loadCharts()
        }, 1000);
    }

    let graficoTemp;
    function loadCharts() {
        temperaturaConstante.forEach((temperatura, index) => {
            if (temperatura > 29 || temperatura < 17) {
                cores[index] = '#FF5555'
            } else if ((temperatura >= 27 && temperatura <= 28) || (temperatura >= 17 && temperatura <= 19)) {
                cores[index] = '#FF9900'
            } else if (temperatura >= 25 && temperatura <= 26) {
                cores[index] = '#FFCC00'
            } else {
                cores[index] = '#74C365'
            }
        });

        if (!firstPlot) {
            atualizarGraficos();
        } else {
            fetch(`/medidas/dados_temperatura/${sessionStorage.ID_USUARIO}`, {
                method: 'GET',
                headers: {
                    "Content-Type": "application/json"
                }
            }).then((resposta) => {
                if (resposta.ok) {
                    resposta.json().then(json => {
                        for (i = 0; i < plantacoes.length; i++) {
                            graficoTemp = new Chart(document.getElementById(`${plantacoes[i].id}`), {
                                type: 'line',
                                data: {
                                    labels: [dataLeitura[0], dataLeitura[1], dataLeitura[2], dataLeitura[3], dataLeitura[4], dataLeitura[5]],
                                    datasets: [{
                                        label: 'Temperatura da plantação dentre o período do meio dia ás cinco da tarde',
                                        backgroundColor: [
                                            'crimson'
                                        ],
                                        data: [temperaturaConstante[0], temperaturaConstante[1], temperaturaConstante[2], temperaturaConstante[3], temperaturaConstante[4], temperaturaConstante[5]],
                                    }]
                                },
                                options: {
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            })
                        }
                    })
                }
            })
        }
        primeiroPlot = false

        setTimeout(() => {
            buscarLeitura()
        }, 1000);
    }

    let dataGraficoTemp, labelsGraficoTemp
    function atualizarGraficos() {
        dataGraficoTemp = graficoTemp.data.datasets[0].data
        labelsGraficoTemp = graficoTemp.data.labels

        dataGraficoTemp.forEach((data, index) => {
            dataGraficoTemp[index] = temperaturaConstante[index]
            labelsGraficoTemp[index] = dataLeitura[index]
        })
        graficoTemp.update()
    }

    // let proximaAtualizacao;

    // window.onload = obterDadosGraficos();

    // function obterDadosGraficos() {
    //     obterDadosGrafico(1)

    // }

    // function obterDadosGrafico(idAquario) {


    //     if (proximaAtualizacao != undefined) {
    //         clearTimeout(proximaAtualizacao);
    //     }

    //     fetch(`/medidas/dados_temperatura/${idAquario}`, { cache: 'no-store' }).then(function (response) {
    //         if (response.ok) {
    //             response.json().then(function (resposta) {
    //                 console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
    //                 resposta.reverse();

    //                 plotarGrafico(resposta, idAquario);

    //             });
    //         } else {
    //             console.error('Nenhum dado encontrado ou erro na API');
    //         }
    //     })
    //         .catch(function (error) {
    //             console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    //         });
    // }


    // function plotarGrafico(resposta, idAquario) {

    //     console.log('iniciando plotagem do gráfico...');

    //     // Criando estrutura para plotar gráfico - labels
    //     let labels = [];

    //     // Criando estrutura para plotar gráfico - dados
    //     let dados = {
    //         labels: labels,
    //         datasets: [{
    //             label: 'Temperatura da plantação dentre o período do meio dia ás cinco da tarde',
    //             backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //             borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //             data: [],
    //             fill: false,

    //             tension: 0.1
    //         },
    //         {
    //             label: '',
    //             data: [],
    //             fill: false,

    //             tension: 0.1
    //         }]
    //     };

    //     console.log('----------------------------------------------')
    //     console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
    //     console.log(resposta)

    //     // Inserindo valores recebidos em estrutura para plotar o gráfico
    //     var temperaturas = [];
    //     for (i = 0; i < resposta.length; i++) {
    //         var registro = resposta[i];
    //         labels.push(registro.temperatura);
    //         dados.datasets[0].data.push(registro.temperatura);
    //         dados.datasets[1].data.push(registro.dataLeitura_hora);
    //         var temperatura = registro.temperatura
    //         temperaturas.push(temperatura)

    //         if (registro.temperatura >= 12) {
    //             dados.datasets[0].backgroundColor.push('#FF0000');
    //             dados.datasets[0].borderColor = '#FF0000';
    //         }
    //     }





    //     console.log('----------------------------------------------')
    //     console.log('O gráfico será plotado com os respectivos valores:')
    //     console.log('Labels:')
    //     console.log(labels)
    //     console.log('Dados:')
    //     console.log("Dados  novos" + temperatura)
    //     console.log('----------------------------------------------')

    //     let dados_grafico1 = labels;
    //     let novos_dados_temperatura = temperaturas
    //     console.log(dados_grafico1)
    //     let dados_grafico2 = [];
    //     let novos_dados_grafico_2 = []

    //     for (var i = 0; i < novos_dados_temperatura.length; i++) {
    //         var valor_nomal = novos_dados_temperatura[i]
    //         var alteracao_grafico_2 = (valor_nomal * 0.50).toFixed(1)

    //         dados_grafico2.push(alteracao_grafico_2)
    //         console.log("GGGAHSH" + alteracao_grafico_2)


    //     }

    //     console.log(dados_grafico1);
    //     console.log('----------------------------------------------');
    //     console.log('O gráfico será plotado com os respectivos valores:');
    //     console.log('Labels:');
    //     console.log(labels);
    //     console.log('Dados:');
    //     console.log(dados.datasets);
    //     console.log('----------------------------------------------');

    //     // Criando estrutura para plotar gráfico - config
    //     let dados2 = {
    //         type: 'line',
    //         data: {
    //             labels: labels,
    //             datasets: [
    //                 {
    //                     label: '',
    //                     backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     data: dados_grafico2,

    //                 },
    //                 {
    //                     label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',
    //                     data: '',

    //                 }
    //             ]
    //         }
    //     };

    //     // Adicionando gráfico criado em div na tela
    //     let myChart2 = new Chart(
    //         document.getElementById(`myChart2`),
    //         dados2
    //     );

    //     for (let i = 0; i < dados_grafico2.length; i++) {
    //         if (dados_grafico2[i] < 12) {
    //             myChart2.data.datasets[0].backgroundColor[i] = 'orange';
    //             myChart2.data.datasets[0].borderColor = 'orange';
    //         }
    //     }




    //     let dados_grafico = temperaturas;
    //     console.log("O grafico 3 tera os seguintes dados " + dados_grafico)
    //     let dados_grafico3 = [];

    //     for (var i = 0; i < dados_grafico.length; i++) {
    //         var valor_original = dados_grafico[i];
    //         var novo_valor = (valor_original * 0.60).toFixed(2);
    //         dados_grafico3.push(novo_valor);

    //         console.log("Valor Normal: " + valor_original);
    //         console.log("Valor Alterado: " + novo_valor);
    //     }


    //     const config3 = {
    //         type: 'line',
    //         data: {
    //             labels: labels,
    //             datasets: [
    //                 {
    //                     label: '',
    //                     backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     data: dados_grafico3,

    //                 },
    //                 {
    //                     label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',

    //                 }
    //             ]
    //         }
    //     };

    //     let myChart3 = new Chart(
    //         document.getElementById(`myChart3`),
    //         config3
    //     );



    //     let dados_grafico_um = temperaturas;
    //     console.log("O grafico 3 tera os seguintes dados " + dados_grafico)
    //     let dados_grafico4 = [];

    //     for (var count = 0; count < dados_grafico_um.length; count++) {
    //         var valor_original = dados_grafico_um[count];
    //         var novo_valor = (valor_original * 1.05).toFixed(2);
    //         dados_grafico4.push(novo_valor);

    //         console.log("Valor Normal: " + valor_original);
    //         console.log("Valor Alterado: " + novo_valor);
    //     }


    //     const config4 = {
    //         type: 'line',
    //         data: {
    //             labels: labels,
    //             datasets: [
    //                 {
    //                     label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',
    //                     data: dados_grafico4,
    //                     fill: false,
    //                     backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     tension: 0.1

    //                 },
    //                 {
    //                     label: '',
    //                     data: '',

    //                 }
    //             ]
    //         }
    //     };
    //     let myChart4 = new Chart(
    //         document.getElementById(`myChart4`),
    //         config4
    //     );



    //     let dados_primeiro_grafico = temperaturas;
    //     console.log("O grafico 3 tera os seguintes dados " + dados_grafico)
    //     let dados_grafico5 = [];

    //     for (var contador = 0; contador < dados_primeiro_grafico.length; contador++) {
    //         var valor_original = dados_primeiro_grafico[contador];
    //         var novo_valor = (valor_original * 0.4).toFixed(2);
    //         dados_grafico5.push(novo_valor);

    //         console.log("Valor Normal: " + valor_original);
    //         console.log("Valor Alterado: " + novo_valor);
    //     }


    //     const config5 = {
    //         type: 'line',
    //         data: {
    //             labels: labels,
    //             datasets: [
    //                 {
    //                     label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',
    //                     data: dados_grafico5,
    //                     fill: false,
    //                     backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     tension: 0.1

    //                 },
    //                 {
    //                     label: '',
    //                     data: '',

    //                 }
    //             ]
    //         }
    //     };

    //     let myChart5 = new Chart(
    //         document.getElementById(`myChart5`),
    //         config5
    //     );






    //     let dados_umidade_geral = temperaturas;
    //     console.log("O grafico 3 tera os seguintes dados " + dados_grafico)
    //     let dados_grafico6 = [];

    //     for (var contador = 0; contador < dados_umidade_geral.length; contador++) {
    //         var valor_original = dados_umidade_geral[contador];
    //         var novo_valor = (valor_original * 0.25).toFixed(2);
    //         dados_grafico6.push(novo_valor);

    //         console.log("Valor Normal: " + valor_original);
    //         console.log("Valor Alterado: " + novo_valor);
    //     }
    //     // Criando estrutura para plotar gráfico - config


    //     const config6 = {
    //         type: 'line',
    //         data: {
    //             labels: labels,
    //             datasets: [
    //                 {
    //                     label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',
    //                     data: dados_grafico6,
    //                     fill: false,
    //                     backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
    //                     tension: 0.1

    //                 },
    //                 {
    //                     label: '',
    //                     data: '',

    //                 }
    //             ]
    //         }
    //     };




    //     let myChart6 = new Chart(
    //         document.getElementById(`myChart6`),
    //         config6
    //     );


    //     const config = {
    //         type: 'line',
    //         data: dados,
    //     };






    //     // Adicionando gráfico criado em div na tela
    //     let myChart = new Chart(
    //         document.getElementById(`myChart1`),
    //         config
    //     );





    //     setTimeout(() => atualizarGrafico(idAquario, dados, myChart, myChart2, myChart3, myChart4, myChart5, myChart6), 2000);
    // }

    // function atualizarGrafico(idAquario, dados, myChart, myChart2, myChart3, myChart4, myChart5, myChart6) {



    //     fetch(`/medidas/medidas_temperatura_ultimas/${idAquario}`, { cache: 'no-store' }).then(function (response) {
    //         if (response.ok) {
    //             response.json().then(function (novoRegistro) {

    //                 obterDadosGrafico(idAquario)

    //                 // tirando e colocando valores no gráfico
    //                 dados.labels.shift(); // apagar o primeiro
    //                 dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

    //                 dados.datasets[0].data.shift();  // apagar o primeiro de umidade
    //                 dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de umidade

    //                 dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
    //                 dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

    //                 myChart.update();




    //                 myChart2.data.labels.shift();
    //                 myChart2.data.labels.push(novoRegistro[0].momento_grafico);

    //                 myChart2.data.datasets[0].data.shift();
    //                 myChart2.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.50);

    //                 myChart2.update();

    //                 myChart3.data.labels.shift();
    //                 myChart3.data.labels.push(novoRegistro[0].momento_grafico);

    //                 myChart3.data.datasets[0].data.shift();
    //                 myChart3.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.45);

    //                 myChart3.update();

    //                 myChart4.data.labels.shift();
    //                 myChart4.data.labels.push(novoRegistro[0].momento_grafico);

    //                 myChart4.data.datasets[0].data.shift();
    //                 myChart4.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.90);

    //                 myChart4.update();

    //                 myChart5.data.labels.shift();
    //                 myChart5.data.labels.push(novoRegistro[0].momento_grafico);

    //                 myChart5.data.datasets[0].data.shift();
    //                 myChart5.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.4);

    //                 myChart5.update();

    //                 myChart6.data.labels.shift();
    //                 myChart6.data.labels.push(novoRegistro[0].momento_grafico);

    //                 myChart6.data.datasets[0].data.shift();
    //                 myChart6.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.85);

    //                 myChart6.update();



    //                 proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart, myChart2, myChart3, myChart4, myChart5,
    //                     myChart6), 2000);
    //             });
    //         } else {
    //             console.error('Nenhum dado encontrado ou erro na API');

    //             proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart, myChart2, myChart3, myChart4, myChart5, myChart6), 2000);
    //         }
    //     })
    //         .catch(function (error) {
    //             console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    //         });

    // }
</script>