<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3185/3185082.png" type="image/x-icon">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/dashboard-especifica.css">
    <title>Dashboard - Cocoa</title>
</head>
<!-- onload="obterDadosGrafico() -->

<body>
    <div id="dashboard-container">
        <nav class="select-disable" id="nav">
            <img src="../assets/img/logotipo/branco.png" alt="Logo Cocoa Technology">
            <div class="texto-user">
                <span>Bem-vindo</span>
                <span id="b_usuario"></span>
            </div>
            <ul class="nav-list">
                <li><a href="./dashboard-geral.html"><img class="icon-nav" src="../assets/img/icones/global.png"
                            alt="Geral"><span>Geral</span></a></li>
                <li><a href="./dashboard-umid.html"><img class="icon-nav" src="../assets/img/icones/moisture-white.png"
                            alt="Umidade">
                        <span>Umidade</span></a>
                </li>
                <li class="pag-atual"><a href="#"><img class="icon-nav" src="../assets/img/icones/thermometer-white.png"
                            alt="Temperatura"><span>Temperatura</span></a>
                </li>
                <li><a href="./cadastrar-usuario.html">
                        <img class="icon-nav" src="../assets/img/icones/user.png" alt="Temperatura">
                        <span>Cadastrar Usuário</span>
                    </a>
                </li>
                <li>
                    <a href="./cadastro-plantacao.html">
                        <img class="icon-nav" src="../assets/img/icones/folha.png" alt="Temperatura">
                        <span>Cadastrar Plantações</span>
                    </a>
                </li>
            </ul>
            <a href="../login.html"><button>SAIR</button></a>
        </nav>
        <div id="content">
            <div class="div-search"><input type="text" placeholder="Pesquisar"></div>
            <span id="plantacoes">
                <div class="slide-show select-disable">
                    <h2>Plantação - Rua Haddock Lobo</h2>
                    <ul class="slides-list">
                        <li class="slide">
                            <canvas id="myChart1"></canvas>
                        </li>
                        <li class="slide">
                            <div class="infos-graficos">
                                <h2>Status da plantação:</h2>
                                <span style="color: #74C365;" class="status">TRANQUILA</span>
                                <div>
                                    <div>
                                        <span>Temperatura atual:</span>
                                        <span style="color: #FF5555;">23°C</span>
                                    </div>
                                    <div>
                                        <span>Temperatura ideal:</span>
                                        <span>10°C a 23°C</span>
                                    </div>
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </span>
        </div>
    </div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
     b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    var plantacoes = [];
    var dataLeitura = [];
    var firstPlot = true;
    var temperaturaConstante = [];
    var cores = [];

    fetch(`/medidas/dados_temperatura/${sessionStorage.ID_USUARIO}`, {
        method: "GET"
    }).then(function (resposta) {
        if (resposta.ok) {
            resposta.json().then((jsonTemp) => {
                console.log(jsonTemp)
                jsonTemp.forEach(linha => {
                    document.getElementById("plantacoes").innerHTML += `
                        <div class="slide-show select-disable">
                            <h2>Plantação - ${linha.nome}</h2>
                            <ul class="slides-list">
                                <li class="slide">
                                    <canvas id="myChart${linha.idplantacao}"></canvas>
                                </li>
                                <li class="slide" id="info${linha.idplantacao}"></li>
                            </ul>
                        </div>
                    `
                    plantacoes.push({ id: linha.idplantacao, nome: linha.nome, temp: linha.temperatura })
                    dataLeitura.push(linha.momento_grafico);
                });
            })
        }
    }).then(() => {
        for (i = 0; i < plantacoes.length; i++) {
            if (plantacoes[i].temp > 29 || plantacoes[i].temp < 17) {
                document.getElementById(`info${plantacoes[i].id}`).innerHTML = `
                    <div class="infos-graficos">
                        <h2>Status da plantação:</h2>
                        <span style="color: #FF5555;" class="status">PERIGO</span>
                        <div>
                            <div>
                                <span>Temperatura atual:</span>
                                <span style="color: #FF5555;">${plantacoes[i].temp}°C</span>
                            </div>
                            <div>
                                <span>Temperatura ideal:</span>
                                <span>10°C a 23°C</span>
                            </div>
                        </div>
                    </div>
                `
            } else if ((plantacoes[i].temp >= 27 && plantacoes[i].temp <= 28) || (plantacoes[i].temp >= 17 && plantacoes[i].temp <= 19)) {
                document.getElementById(`info${plantacoes[i].id}`).innerHTML = `
                    <div class="infos-graficos">
                        <h2>Status da plantação:</h2>
                        <span style="color: #FF9900;" class="status">ATENÇÃO</span>
                        <div>
                            <div>
                                <span>Temperatura atual:</span>
                                <span style="color: #FF9900;">${plantacoes[i].temp}°C</span>
                            </div>
                            <div>
                                <span>Temperatura ideal:</span>
                                <span>10°C a 23°C</span>
                            </div>
                        </div>
                    </div>
                `
            } else if (plantacoes[i].temp >= 25 && plantacoes[i].temp <= 26) {
                document.getElementById(`info${plantacoes[i].id}`).innerHTML = `
                    <div class="infos-graficos">
                        <h2>Status da plantação:</h2>
                        <span style="color: #FFCC00;" class="status">CUIDADO</span>
                        <div>
                            <div>
                                <span>Temperatura atual:</span>
                                <span style="color: #FFCC00;">${plantacoes[i].temp}°C</span>
                            </div>
                            <div>
                                <span>Temperatura ideal:</span>
                                <span>10°C a 23°C</span>
                            </div>
                        </div>
                    </div>
                `
            } else {
                document.getElementById(`info${plantacoes[i].id}`).innerHTML = `
                    <div class="infos-graficos">
                        <h2>Status da plantação:</h2>
                        <span style="color: #74C365;" class="status">TRANQUILA</span>
                        <div>
                            <div>
                                <span>Temperatura atual:</span>
                                <span style="color: #74C365;">${plantacoes[i].temp}°C</span>
                            </div>
                            <div>
                                <span>Temperatura ideal:</span>
                                <span>10°C a 23°C</span>
                            </div>
                        </div>
                    </div>
                `
            }
        }
    });

    function buscarLeitura() {
        fetch(`/medidas/dados_temperatura/${sessionStorage.ID_USUARIO}`, {
            method: 'GET',
            headers: {
                "Content-Type": "application/json"
            }
        }).then((resposta) => {
            if (resposta.ok) {
                resposta.json().then(json => {
                    if (temperaturaConstante.length < 6) {
                        temperaturaConstante.push(json[0].temperatura)
                        dataLeitura.push(json[0].momento_grafico)
                    } else {
                        temperaturaConstante.shift()
                        dataLeitura.shift()

                        temperaturaConstante.push(json[0].temperatura)
                        dataLeitura.push(json[0].momento_grafico)
                    }
                })
            }
        })
        setTimeout(() => {
            loadCharts()
        }, 1000);
    }

    let graficoTemp;
    function loadCharts() {
        temperaturaConstante.forEach((temperatura, index) => {
            if (temperatura > 29 || temperatura < 17) {
                cores[index] = '#FF5555'
            } else if ((temperatura >= 27 && temperatura <= 28) || (temperatura >= 17 && temperatura <= 19)) {
                cores[index] = '#FF9900'
            } else if (temperatura >= 25 && temperatura <= 26) {
                cores[index] = '#FFCC00'
            } else {
                cores[index] = '#74C365'
            }
        });

        if (!firstPlot) {
            atualizarGraficos();
        } else {
            fetch(`/medidas/dados_temperatura/${sessionStorage.ID_USUARIO}`, {
                method: 'GET',
                headers: {
                    "Content-Type": "application/json"
                }
            }).then((resposta) => {
                if (resposta.ok) {
                    resposta.json().then(json => {
                        for (i = 0; i < plantacoes.length; i++) {
                            graficoTemp = new Chart(document.getElementById(`myChart${plantacoes[i].id}`), {
                                type: 'line',
                                data: {
                                    labels: [dataLeitura[0], dataLeitura[1], dataLeitura[2], dataLeitura[3], dataLeitura[4], dataLeitura[5]],
                                    datasets: [{
                                        label: 'Temperatura da plantação dentre o período do meio dia ás cinco da tarde',
                                        backgroundColor: [
                                            'crimson'
                                        ],
                                        data: [temperaturaConstante[0], temperaturaConstante[1], temperaturaConstante[2], temperaturaConstante[3], temperaturaConstante[4], temperaturaConstante[5]],
                                        borderColor: [
                                            'rgba(255, 99, 132, 1)'
                                        ],
                                        borderWidth: 3
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    scales: {
                                        y: {
                                            beginAtZero: true
                                        }
                                    }
                                }
                            });
                        }
                    })
                }
            })
            firstPlot = false;
        }
    }

    function atualizarGraficos() {
        for (i = 0; i < plantacoes.length; i++) {
            fetch(`/medidas/dados_temperatura/${sessionStorage.ID_USUARIO}`, {
                method: 'GET',
                headers: {
                    "Content-Type": "application/json"
                }
            }).then((resposta) => {
                if (resposta.ok) {
                    resposta.json().then(json => {
                        graficoTemp.data.labels.shift();
                        graficoTemp.data.labels.push(json[0].momento_grafico);

                        graficoTemp.data.datasets.forEach((dataset) => {
                            dataset.data.shift();
                            dataset.data.push(json[0].temperatura);
                            dataset.borderColor = cores;
                        });

                        graficoTemp.update();
                    })
                }
            })
        }
    }

    setInterval(buscarLeitura, 10000);
</script>