<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3185/3185082.png" type="image/x-icon">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/dashboard-especifica.css">
    <title>Dashboard - Cocoa</title>
</head>

<body onload="obterDadosGrafico()">
    <div id="dashboard-container">
        <nav class="select-disable" id="nav">
            <img src="../assets/img/logotipo/branco.png" alt="Logo Cocoa Technology">
            <div class="texto-user">
                <span>Bem-vindo</span>
                <span id="b_usuario"></span>
            </div>
            <ul class="nav-list">
                <li><a href="./dashboard-geral.html"><img class="icon-nav" src="../assets/img/icones/global.png"
                            alt="Geral"><span>Geral</span></a></li>
                <li><a href="./dashboard-umid.html"><img class="icon-nav" src="../assets/img/icones/moisture-white.png"
                            alt="Umidade">
                        <span>Umidade</span></a>
                </li>
                <li class="pag-atual"><a href="#"><img class="icon-nav" src="../assets/img/icones/thermometer-white.png"
                            alt="Temperatura"><span>Temperatura</span></a>
                </li>
                <li><a href="./cadastrar-usuario.html">
                        <img class="icon-nav" src="../assets/img/icones/user.png" alt="Temperatura">
                        <span>Cadastrar Usuário</span>
                    </a>
                </li>
                <li>
                    <a href="./cadastro-plantacao.html">
                        <img class="icon-nav" src="../assets/img/icones/folha.png" alt="Temperatura">
                        <span>Cadastrar Plantações</span>
                    </a>
                </li>
            </ul>
            <a href="../login.html"><button>SAIR</button></a>
        </nav>
        <div id="content">
            <div class="div-search"><input type="text" placeholder="Pesquisar"></div>
            <span id="conteudo_container">
                <!-- <div class="slide-show select-disable">
                    <h2>Plantação - Rua Haddock Lobo</h2>
                    <ul class="slides-list">
                        <li class="slide">
                            <canvas id="myChart1"></canvas>
                        </li>
                        <li class="slide">
                            <canvas id="myChart2"></canvas>
                        </li>
                    </ul>
                </div>
                <div class="slide-show select-disable">
                    <h2>Plantação - Rua Serra das Araras</h2>
                    <ul class="slides-list">
                        <li class="slide">
                            <canvas id="myChart3"></canvas>
                        </li>
                        <li class="slide">
                            <canvas id="myChart4"></canvas>
                        </li>
                    </ul>
                </div>
                <div class="slide-show select-disable">
                    <h2>Plantação - Rua Haddock Lobo</h2>
                    <ul class="slides-list">
                        <li class="slide">
                            <canvas id="myChart5"></canvas>
                        </li>
                        <li class="slide">
                            <canvas id="myChart6"></canvas>
                        </li>
                    </ul>
                </div> -->
            </span>
        </div>
</body>

</html>
<script src="./js/dashboard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let proximaAtualizacao;

    window.onload = exibirPlantacoes();

    var charts = [];

    function obterDadosGraficos() {
        exibirPlantacoes(),
            obterDadosGrafico(1)
    }

    function exibirPlantacoes() {
        fetch(`/medidas/exibirPlantacoes/${sessionStorage.ID_USUARIO}`, {
            method: 'GET',
            headers: {
                'Content-type': 'application/json'
            }
        }).then((resposta) => {
            if (resposta.ok) {
                resposta.json().then((jsonPlantacoes) => {
                    jsonPlantacoes.forEach(linha => {
                        document.getElementById('conteudo_container').innerHTML += `
                        <div class="slide-show select-disable">
                            <h2>Plantação - ${linha.nome}</h2>
                            <ul class="slides-list">
                                <li class="slide">
                                    <canvas id="myChart${linha.idplantacao}"></canvas>
                                </li>
                                <li class="slide">
                                    <canvas id="myChart${linha.idplantacao}_alter"></canvas>
                                </li>
                             </ul>
                        </div>
                    `
                    });
                    charts.push(`document.getElementById('myChart${linha.idplantacao}')`)
                    charts.push(`document.getElementById('myChart${linha.idplantacao}_alter')`)

                    fetch(`/medidas/exibirLeituraPlantacoes/${linha.idplantacao}`, { cache: 'no-store' }).then(function (response) {
                        if (response.ok) {
                            response.json().then(function (resposta) {
                                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                                resposta.reverse();


                                console.log('iniciando plotagem do gráfico...');
                                let labels = [];

                                let dados = {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Temperatura da plantação em tempo real',
                                        backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                                        borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                                        data: [],
                                        fill: false,
                                        tension: 0.1
                                    },
                                    {
                                        label: '',
                                        data: [],
                                        fill: false,
                                        tension: 0.1
                                    }]
                                };

                                for (i = 0; i < resposta.length; i++) {
                                    var registro = resposta[i];
                                    labels.push(registro.nome);
                                    dados.datasets[0].data.push(registro.temperatura);
                                    dados.datasets[1].data.push(registro.dataLeitura_hora);

                                    var temperatura = registro.temperatura
                                    temperaturas.push(temperatura)
                                }

                                const config = {
                                    type: 'line',
                                    data: dados,
                                };
                                // Adicionando gráfico criado em div na tela
                                let myChart = new Chart(
                                    document.getElementById(`myChar${linha.idplantacao}`),
                                    config
                                );
                            });
                        } else {
                            console.error('Nenhum dado encontrado ou erro na API');
                        }
                    }).catch(function (error) {
                        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
                    });
                })
            } else {
                console.log('Erro no .THEN');
            }
        })
    }

    function obterDadosGrafico(idAquario) {
        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/dados_temperatura/${idAquario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                    resposta.reverse();

                    plotarGrafico(resposta, idAquario);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }


    function plotarGrafico(resposta, idPlantacao) {
        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Temperatura da plantação em tempo real',
                backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                data: [],
                fill: false,
                tension: 0.1
            },
            {
                label: '',
                data: [],
                fill: false,
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        var temperaturas = [];

        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.nome);
            dados.datasets[0].data.push(registro.temperatura);
            dados.datasets[1].data.push(registro.dataLeitura_hora);

            var temperatura = registro.temperatura
            temperaturas.push(temperatura)

            // if (registro.temperatura >= 12) {
            //     dados.datasets[0].backgroundColor.push('#FF0000');
            //     dados.datasets[0].borderColor = '#FF0000';
            // }
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log("Dados  novos" + temperatura)
        console.log('----------------------------------------------')

        let dados_grafico1 = labels;
        let novos_dados_temperatura = temperaturas
        console.log(dados_grafico1)
        let dados_grafico2 = [];
        let novos_dados_grafico_2 = []

        for (var i = 0; i < novos_dados_temperatura.length; i++) {
            var valor_nomal = novos_dados_temperatura[i]
            var alteracao_grafico_2 = (valor_nomal * 0.50).toFixed(1)

            dados_grafico2.push(alteracao_grafico_2)
            console.log("GGGAHSH" + alteracao_grafico_2)
        }

        console.log(dados_grafico1);
        console.log('----------------------------------------------');
        console.log('O gráfico será plotado com os respectivos valores:');
        console.log('Labels:');
        console.log(labels);
        console.log('Dados:');
        console.log(dados.datasets);
        console.log('----------------------------------------------');

        // Criando estrutura para plotar gráfico - config
        let dados2 = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '',
                        backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        data: dados_grafico2,

                    },
                    {
                        label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',
                        data: '',

                    }
                ]
            }
        };

        // Adicionando gráfico criado em div na tela
        let myChart2 = new Chart(
            document.getElementById(`myChart2`),
            dados2
        );

        for (let i = 0; i < dados_grafico2.length; i++) {
            if (dados_grafico2[i] < 12) {
                myChart2.data.datasets[0].backgroundColor[i] = 'orange';
                myChart2.data.datasets[0].borderColor = 'orange';
            }
        }

        let dados_grafico = temperaturas;
        console.log("O grafico 3 tera os seguintes dados " + dados_grafico)
        let dados_grafico3 = [];

        for (var i = 0; i < dados_grafico.length; i++) {
            var valor_original = dados_grafico[i];
            var novo_valor = (valor_original * 0.60).toFixed(2);
            dados_grafico3.push(novo_valor);

            console.log("Valor Normal: " + valor_original);
            console.log("Valor Alterado: " + novo_valor);
        }

        const config3 = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '',
                        backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        data: dados_grafico3,

                    },
                    {
                        label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',

                    }
                ]
            }
        };

        let myChart3 = new Chart(
            document.getElementById(`myChart3`),
            config3
        );

        let dados_grafico_um = temperaturas;
        console.log("O grafico 3 tera os seguintes dados " + dados_grafico)
        let dados_grafico4 = [];

        for (var count = 0; count < dados_grafico_um.length; count++) {
            var valor_original = dados_grafico_um[count];
            var novo_valor = (valor_original * 1.05).toFixed(2);
            dados_grafico4.push(novo_valor);

            console.log("Valor Normal: " + valor_original);
            console.log("Valor Alterado: " + novo_valor);
        }

        const config4 = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',
                        data: dados_grafico4,
                        fill: false,
                        backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        tension: 0.1

                    },
                    {
                        label: '',
                        data: '',

                    }
                ]
            }
        };
        let myChart4 = new Chart(
            document.getElementById(`myChart4`),
            config4
        );

        let dados_primeiro_grafico = temperaturas;
        console.log("O grafico 3 tera os seguintes dados " + dados_grafico)
        let dados_grafico5 = [];

        for (var contador = 0; contador < dados_primeiro_grafico.length; contador++) {
            var valor_original = dados_primeiro_grafico[contador];
            var novo_valor = (valor_original * 0.4).toFixed(2);
            dados_grafico5.push(novo_valor);

            console.log("Valor Normal: " + valor_original);
            console.log("Valor Alterado: " + novo_valor);
        }


        const config5 = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',
                        data: dados_grafico5,
                        fill: false,
                        backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        tension: 0.1

                    },
                    {
                        label: '',
                        data: '',

                    }
                ]
            }
        };

        let myChart5 = new Chart(
            document.getElementById(`myChart5`),
            config5
        );

        let dados_umidade_geral = temperaturas;
        console.log("O grafico 3 tera os seguintes dados " + dados_grafico)
        let dados_grafico6 = [];

        for (var contador = 0; contador < dados_umidade_geral.length; contador++) {
            var valor_original = dados_umidade_geral[contador];
            var novo_valor = (valor_original * 0.25).toFixed(2);
            dados_grafico6.push(novo_valor);

            console.log("Valor Normal: " + valor_original);
            console.log("Valor Alterado: " + novo_valor);
        }
        // Criando estrutura para plotar gráfico - config


        const config6 = {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Temperatura da plantação dentre o período do meio dia às cinco da tarde',
                        data: dados_grafico6,
                        fill: false,
                        backgroundColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        borderColor: ['#FF9900', '#74C365', '#FFCC00', 'FF5555'],
                        tension: 0.1
                    },
                    {
                        label: '',
                        data: '',

                    }
                ]
            }
        };

        let myChart6 = new Chart(
            document.getElementById(`myChart6`),
            config6
        );

        const config = {
            type: 'line',
            data: dados,
        };
        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChart1`),
            config
        );
        setTimeout(() => atualizarGrafico(idAquario, dados, myChart, myChart2, myChart3, myChart4, myChart5, myChart6), 2000);
    }

    function atualizarGrafico(idAquario, dados, myChart, myChart2, myChart3, myChart4, myChart5, myChart6) {
        fetch(`/medidas/medidas_temperatura_ultimas/${idAquario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (novoRegistro) {

                    obterDadosGrafico(idAquario)

                    // tirando e colocando valores no gráfico
                    dados.labels.shift(); // apagar o primeiro
                    dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

                    dados.datasets[0].data.shift();  // apagar o primeiro de umidade
                    dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de umidade

                    dados.datasets[0].data.shift();  // apagar o primeiro de temperatura
                    dados.datasets[0].data.push(novoRegistro[0].temperatura); // incluir uma nova medida de temperatura

                    myChart.update();

                    myChart2.data.labels.shift();
                    myChart2.data.labels.push(novoRegistro[0].momento_grafico);

                    myChart2.data.datasets[0].data.shift();
                    myChart2.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.50);

                    myChart2.update();

                    myChart3.data.labels.shift();
                    myChart3.data.labels.push(novoRegistro[0].momento_grafico);

                    myChart3.data.datasets[0].data.shift();
                    myChart3.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.45);

                    myChart3.update();

                    myChart4.data.labels.shift();
                    myChart4.data.labels.push(novoRegistro[0].momento_grafico);

                    myChart4.data.datasets[0].data.shift();
                    myChart4.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.90);

                    myChart4.update();

                    myChart5.data.labels.shift();
                    myChart5.data.labels.push(novoRegistro[0].momento_grafico);

                    myChart5.data.datasets[0].data.shift();
                    myChart5.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.4);

                    myChart5.update();

                    myChart6.data.labels.shift();
                    myChart6.data.labels.push(novoRegistro[0].momento_grafico);

                    myChart6.data.datasets[0].data.shift();
                    myChart6.data.datasets[0].data.push(novoRegistro[0].temperatura * 0.85);

                    myChart6.update();

                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart, myChart2, myChart3, myChart4, myChart5,
                        myChart6), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');

                proximaAtualizacao = setTimeout(() => atualizarGrafico(idAquario, dados, myChart, myChart2, myChart3, myChart4, myChart5, myChart6), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }

</script>