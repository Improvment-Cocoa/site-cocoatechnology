<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/3185/3185082.png" type="image/x-icon">
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/dashboard-geral.css">
    <title>Dashboard Geral - Cocoa</title>
</head>

<body onload="obterDadosGrafico() , obterTemperaturaAtual()">
    <div id="dashboard-container">
        <nav class="select-disable" id="nav">
            <img src="../assets/img/logotipo/branco.png" alt="Logo Cocoa Technology">
            <div class="texto-user">
                <span>Bem-vindo</span>
                <span id="b_usuario"></span>
            </div>
            <ul class="nav-list">
                <li class="pag-atual"><a href="./dashboard-geral.html">
                        <img class="icon-nav" src="../assets/img/icones/global.png" alt="Geral">
                        <span>Geral</span></a>
                </li>
                <li>
                    <a href="./dashboard-umid.html">
                        <img class="icon-nav" src="../assets/img/icones/moisture-white.png" alt="Umidade">
                        <span>Umidade</span>
                    </a>
                </li>
                <li>
                    <a href="./dashboard-temp.html">
                        <img class="icon-nav" src="../assets/img/icones/thermometer-white.png" alt="Temperatura">
                        <span>Temperatura</span>
                    </a>
                </li>
                <li><a href="./cadastrar-usuario.html">
                        <img class="icon-nav" src="../assets/img/icones/user.png" alt="Temperatura">
                        <span>Cadastrar Usuário</span>
                    </a>
                </li>
                <li>
                    <a href="./cadastro-plantacao.html">
                        <img class="icon-nav" src="../assets/img/icones/folha.png" alt="Temperatura">
                        <span>Cadastrar Plantações</span>
                    </a>
                </li>
            </ul>
            <a href="../login.html"><button>SAIR</button></a>
        </nav>
        <div id="content">
            <div class="first-div-container">
                <div class="chart-container-grande">
                    <h2>Temperatura constante das plantações (5 dias)</h2>
                    <div class="div-chart-grande">
                        <canvas id="myChart1"></canvas>
                    </div>
                </div>
                <div class="div-info-row">
                    <div class="info-row">
                        <div><span>4</span>
                            <h4>Plantações Cadastradas</h4>
                        </div>
                        <img src="../assets/img/icones/folha.png" alt="Folha">
                    </div>
                    <div class="info-row">
                        <div><span>2</span>
                            <h4>Plantações em alerta</h4>
                        </div>
                        <img src="../assets/img/icones/danger-alt.png" alt="Atenção">
                    </div>
                    <div class="info-row">
                        <div><span>5</span>
                            <h4>Usuários Cadastrados</h4>
                        </div>
                        <img src="../assets/img/icones/user.png" alt="Usuário">
                    </div>
                </div>
            </div>
            <div class="second-div-container">
                <div class="chart-container-medium">
                    <h2>Status das plantações cadastradas</h2>
                    <div class="div-chart-medium">
                        <canvas id="myChart2"></canvas>
                    </div>
                </div>
                <div class="chart-container-medium">
                    <h2>Temperatura atual da plantações</h2>
                    <div class="div-chart-medium">
                        <canvas id="myChart3"></canvas>
                    </div>
                </div>
                <div class="alert-div">
                    <input type="text" placeholder="Pesquisar">
                    <div class="alert-row">
                        <div><img src="../assets/img/icones/danger.png" alt="Perigo"><span>Serra das araras</span></div>
                        <div><img src="../assets/img/icones/orange-alert.png" alt="Perigo"><span>Rua Augusta</span>
                        </div>
                        <div><img src="../assets/img/icones/warning.png" alt="Atenção"><span>Tingoassuiba</span></div>
                        <div><img src="../assets/img/icones/fine.png" alt="Ok"><span>Haddock Lobo</span></div>
                        <div><img src="../assets/img/icones/fine.png" alt="Ok"><span>Domingos lobos</span></div>
                    </div>
                </div>
            </div>
        </div>
        <script type="text/javascript">var $zoho=$zoho || {};$zoho.salesiq = $zoho.salesiq || {widgetcode:"ba8e3b9f72f9d967ced760ef8825597bd6b90724b968693c3a315187b52e89df2ea958997ca1cc1300b0af5632367fc7", values:{},ready:function(){}};var d=document;s=d.createElement("script");s.type="text/javascript";s.id="zsiqscript";s.defer=true;s.src="https://salesiq.zoho.com/widget";t=d.getElementsByTagName("script")[0];t.parentNode.insertBefore(s,t);d.write("<div id='zsiqwidget'></div>");</script>
</body>

</html>
<script src="./js/dashboard.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let proximaAtualizacao;

    window.onload = obterDadosGraficos();

    function obterDadosGraficos() {
        obterDadosGrafico(1),
        obterTemperaturaAtual()
       
    }

  


   
    function obterDadosGrafico(idAquario) {

    

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/temperatura_contante/${idAquario}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
             

                    plotarGrafico(resposta, idAquario);
                    
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    function plotarGrafico(resposta, idAquario) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'Umidade constante captura das plantações',
                data: [],
                backgroundColor: ['crimson', '#E25822', '#DAA520', '#99CC33', '#99CC33'],
                borderColor: ['crimson', '#E25822', '#DAA520', '#99CC33', '#99CC33'],
                fill: false,
               
                tension: 0.1
            },
            {
                label: 'Temperatura constante captura das plantações',
                data: [],
                fill: false,
                backgroundColor: ['#4fb37c'],
                borderColor: '#4fb37c',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.nome);
            dados.datasets[0].data.push(registro.umidade);
            dados.datasets[1].data.push(registro.temperatura);
            console.log(registro)
            
        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'bar',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChart1`),
            config
        );

    
    }





    function obterTemperaturaAtual(idAquario) {

    

if (proximaAtualizacao != undefined) {
    clearTimeout(proximaAtualizacao);
}

fetch(`/medidas/temperatura_atual/${idAquario}`, { cache: 'no-store' }).then(function (response) {
    if (response.ok) {
        response.json().then(function (resposta_temperatura) {
            console.log(`Dados recebidos para as temperaturas contantes: ${JSON.stringify(resposta_temperatura)}`);
     

            plotarGrafico2(resposta_temperatura, idAquario);
            
        });
    } else {
        console.error('Nenhum dado encontrado ou erro na API');
    }
})
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}




function plotarGrafico2(resposta_temperatura, idAquario) {

console.log('iniciando plotagem do gráfico...');

// Criando estrutura para plotar gráfico - labels
let labels = [];

// Criando estrutura para plotar gráfico - dados
let dados = {
    labels: labels,
    datasets: [{
        label: 'Temperatura',
        data: [],
        backgroundColor: ['crimson', '#E25822', '#DAA520', '#99CC33', '#99CC33'],
        borderColor: ['crimson', '#E25822', '#DAA520', '#99CC33', '#99CC33'],
        fill: false,
       
        tension: 0.1
    },
    {
        label: 'Umidade',
        data: [],
        fill: false,
        backgroundColor: ['#4fb37c'],
        borderColor: '#4fb37c',
        tension: 0.1
    }]
};

console.log('----------------------------------------------')
console.log('Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
console.log(resposta_temperatura)

// Inserindo valores recebidos em estrutura para plotar o gráfico
for (i = 0; i < resposta_temperatura.length; i++) {
    var registro = resposta_temperatura[i];
    labels.push(registro.nome);
    dados.datasets[0].data.push(registro.temperatura);
    dados.datasets[1].data.push(registro.umidade);
    console.log(registro)
    

  
}

console.log('----------------------------------------------')
console.log('O gráfico será plotado com os respectivos valores:')
console.log('Labels:')
console.log(labels)
console.log('Dados:')
console.log(dados.datasets)
console.log('----------------------------------------------')

// Criando estrutura para plotar gráfico - config
const config = {
    type: 'line',
    data: dados,
};

// Adicionando gráfico criado em div na tela
let myChart = new Chart(
    document.getElementById(`myChart3`),
    config
);


}



</script>